{"version":3,"names":[],"mappings":"","sources":["index.js"],"sourcesContent":["(function($) {\n  $(function($) {\n    // 解决300ms延迟\n    FastClick.attach(document.body)\n\n    // ===========> 数据渲染交互之外的逻辑（环境判断）<===========\n    // 首先判断顶层window对象 getAppInfo\n    // 默认是app环境\n    let env = 'app'\n    if (!window.getAppInfo) {\n      env = 'browser'\n    }\n\n    // 加载时判断是否是微信页面\n    function load() {\n      if (utils.isWeixinBrowser) {\n        // 引导用户到浏览器中打开h5\n        // ...\n      }\n    }\n\n    load()\n\n    // 唤醒app 采用urlScheme\n    let openApp = () => {\n      /* eslint-disable no-unused-vars */\n      let urlScheme = 'duomi://'\n      let hasApp = true\n      let timeoutTimer = null\n      let downloadTimer = null\n      let t = 1000\n      let t1 = null\n      let t2 = null\n      /* eslint-enable no-unused-vars */\n\n      downloadTimer = setTimeout(() => {\n        if (!hasApp) {\n          window.location = 'download://'\n        }\n      }, 2000)\n\n      // 记录初始时间\n      t1 = Date.now()\n\n      // 生成iframe(iOS9需要兼容)\n      let ifr = document.createElement('iframe')\n      ifr.setAttribute('style', 'display:none')\n      ifr.setAttribute('src', urlScheme)\n      document.body.appendChild(ifr)\n\n      // timeout\n      timeoutTimer = setTimeout(() => {\n        t2 = Date.now()\n        if (t2 - t1 < t + 300) {\n          hasApp = false\n          // 移除iframe\n          document.body.removeChild(ifr)\n        }\n      }, t)\n    }\n\n    // =============> 前端交互逻辑start <=============\n    // 通过url获取用户accountId\n    let accountId = utils.getParameterByName('accountId')\n\n    // 统一管理url\n    let url = {\n      // 文章商品列表\n      articlelist: 'https://shiziquan.com/shiziquan/learn?action=articlelist&accountId=1000036&artId=136',\n      // 点击商品卡片获取真实的linkurl 和 淘口令\n      getitemdetail: 'https://shiziquan.com/shiziquan/learn?action=getitemdetail',\n      // 文章内淘宝链或者天猫链点击获取真实linkurl 和 淘口令\n      urlpidformat: 'https://shiziquan.com/shiziquan/learn?action=urlpidformat'\n    }\n\n    // 数据请求前显示loading\n    $('.loading').show()\n\n    // 请求文章内容\n    $.ajax({\n      type: 'GET',\n      url: url.articlelist,\n      dataType: 'json',\n      success: function(res) {\n        $('.wrapper').show()\n        $('.loading').hide()\n        let data = res.data\n        if (!utils.isEmptyObject(data)) {\n          let dataAry = data.items\n          if (dataAry && dataAry.length) {\n            // 渲染数据\n            renderArticleInfo(dataAry[0])\n            renderGoodsList(dataAry[0].content)\n            renderRelatedGoods(dataAry[0].numInfos)\n\n            // 取消\ba标签的默认行为\n            articleLink()\n          }\n        } else {\n          alert('文章不存在,请刷新重试')\n        }\n      },\n      error: function(xhr, type) {\n        alert('服务器繁忙!')\n        $('.loading').hide()\n      }\n    })\n\n    // 当文章内容出现带有天猫或者淘宝的链接时阻止跳转并发送请求\n    function articleLink() {\n      $('a').each((index, item) => {\n        let href = item.href\n        if (href.indexOf('taobao') > -1 || href.indexOf('tmall') > -1) {\n          item.addEventListener('click', (e) => {\n            e = e || window.event\n            if (e.preventDefault) {\n              e.preventDefault()\n            } else {\n              e.returnValue = false\n            }\n            $.ajax({\n              url: url.urlpidformat,\n              type: 'POST',\n              data: {\n                accountId,\n                linkUrl: href\n              },\n              dataType: 'json',\n              success(res) {\n                let data = res.data\n                if (!utils.isEmptyObject(data)) {\n                  let linkUrl = data.linkUrl\n                  let tpwd = data.tpwd\n                  showTKLDialog(tpwd, linkUrl)\n                }\n              },\n              error() {\n                alert('服务器繁忙!')\n              }\n            })\n          })\n        }\n      })\n    }\n\n    // 渲染文章相关信息\n    function renderArticleInfo(data) {\n      let createTime = data.createTime\n      let title = data.title\n      let descTitle = data.desc_title\n      let headerBg = data.pict_url\n      let artSource = data.artSource\n      $('.label').text(artSource)\n      $('.content-source .date').text(createTime)\n      $('.header-bg').attr('src', headerBg)\n      $('.content-title span').text(title)\n      $('.content-desc p').text(descTitle)\n    }\n\n    // 显示淘口令对话框\n    function showTKLDialog(taoCommand, taoUrl) {\n      $('.modal-content .password').text(taoCommand)\n      $('.modal-content .tip').attr('data-clipboard-text', taoCommand)\n      $('.modal-content .url').attr('data-clipboard-text', taoUrl)\n      utils.copy('.modal-content .tip')\n      utils.copy('.modal-content .url')\n      dialogShow()\n    }\n\n    // 商品卡片点击处理函数 (包含环境判断)\n    function goodsCardHandler(el) {\n      // 浏览器环境\n      if (env === 'browser') {\n        // 获取用户id\n        let numIid = el.data('commodityid')\n        // 请求跳转链接\n        $.ajax({\n          url: url.getitemdetail,\n          type: 'POST',\n          data: {\n            accountId,\n            num_iid: numIid\n          },\n          dataType: 'json',\n          success(res) {\n            let data = res.data\n            if (!utils.isEmptyObject(data)) {\n              let tbkItemInfo = data.tbkItemInfo\n              let taoCommand = tbkItemInfo.tpwd\n              let taoUrl = tbkItemInfo.coupon_click_url\n              showTKLDialog(taoCommand, taoUrl)\n            }\n          },\n          error() {\n            alert('服务器繁忙!')\n          }\n        })\n      } else { // app环境\n\n      }\n    }\n\n    // 渲染商品列表\n    function renderGoodsList(data) {\n      $('.rich-text-editor').html(data)\n\n      // 卡片绑定点击事件, 根据运行环境不同而进行不同的操作处理\n      $('.commodityCard').click(function() {\n        goodsCardHandler($(this))\n      })\n    }\n\n    // 显示dialog\n    function dialogShow () {\n      $('.dialog-modal').show()\n    }\n\n    // 关闭dialog\n    $('.modal-content--btn').click(() => {\n      $('.dialog-modal').hide()\n    })\n\n    // 渲染相关商品 及 actionSheet options\n    function renderRelatedGoods(data) {\n      let htmlAry = []\n      let goodsLength = data.length\n      // 有相关商品时\n      if (goodsLength) {\n        for (let i = 0; i <= data.length; i++) {\n          let cur = data[i]\n          if (cur) {\n            let str = `\n            <li>\n              <a class=\"relatedGoods\" data-commodityid=\"${cur.num_iid}\">\n                <div class=\"left\"><img src=\"${cur.pict_url}\"></div>\n                <div class=\"right\">\n                  <div class=\"product-title\">${cur.title}</div>\n                  <div class=\"bottom\">\n                    <div class=\"price\">￥29.8</div>\n                    <div class=\"btn\">去购买</div>\n                  </div>\n                </div>\n              </a>\n            </li>\n            `\n            htmlAry.push(str)\n          }\n        }\n\n        $('.related-goods').append(htmlAry.join(''))\n\n        // 当相关商品大于1时渲染actionSheet\n        if (goodsLength > 1) {\n          renderActionSheet(data)\n        }\n\n        // 点击相关商品卡片弹出对话框\n        $('.relatedGoods').click(function() {\n          goodsCardHandler($(this))\n        })\n\n        // 底部按钮渲染处理\n        let btnStr = ''\n\n        if (env === 'browser') {\n          btnStr = `\n          <a href=\"javascript:void(0)\" class=\"through-link\">直达链接</a>\n          <a href=\"javascript:void(0)\" class=\"rebate\">返利模式购买</a>\n          `\n        } else {\n          btnStr = '<a href=\"javascript:void(0)\" class=\"through-link\">直达链接</a>'\n        }\n\n        // 渲染底部按钮\n        $('.bottom-btns-container .btns').append(btnStr)\n\n        // 获取el 直达链接\n        let $througnLink = $('.through-link')\n\n        // 底部按钮交互处理\n        if (env === 'browser') {\n          // 初始化dom变量\n          let $rebate = $('.rebate')\n\n          // 如果商品数量大于1\n          if (goodsLength > 1) {\n            $througnLink.click((e) => {\n              actionSheetShow(e)\n            })\n\n            // 跳转到下载链接\n            $rebate.click(() => {\n              window.location = ''\n            })\n          } else if (goodsLength === 1) {\n            $througnLink.click((e) => {\n              dialogShow()\n            })\n\n            // 跳转到下载链接\n            $rebate.click(() => {\n              window.location = ''\n            })\n          }\n        } else { // app环境下\n          if (goodsLength > 1) {\n            $througnLink.click((e) => {\n              actionSheetShow(e)\n            })\n          } else if (goodsLength === 1) {\n            $througnLink.click((e) => {\n              // 调取原生方法跳到商品详情\n              // ...\n            })\n          }\n        }\n      } else { // 相关商品数量为0\n        $('.related-products').hide()\n        let str = `<a href=\"javascript:void(0)\" class=\"view-more-detail\">打开APP看更多爆料文章</a>`\n        // 浏览器下显示按钮：打开APP看更多爆料文章\n        // app下没有按钮显示\n        if (env === 'browser') {\n          $('.bottom-btns-container .btns').append(str)\n          $('.activity-desc').css('marginBottom', '.8rem')\n        }\n      }\n    }\n\n    // 渲染actionSheet列表\n    function renderActionSheet(goods) {\n      let htmlAry = []\n      for (let i = 0; i < goods.length; i++) {\n        let cur = goods[i]\n        let str = `\n        <li>\n          <p class=\"title\">${cur.title}</p>\n          <a class=\"btn\" href=\"javascript:;\" data-commodityid=\"${cur.num_iid}\">直达链接</a>\n        </li>\n        `\n        htmlAry.push(str)\n      }\n      $('.action-sheet--list').append(htmlAry.join(''))\n\n      $('.action-sheet--list li .btn').click(function(e) {\n        goodsCardHandler($(this))\n        actionSheetHide(e)\n      })\n    }\n\n    // ======> actionsheet 显示隐藏逻辑 <=======\n    function actionSheetShow(e) {\n      $('.action-sheet-modal').show()\n      $('.action-sheet').addClass('up')\n      e.stopPropagation()\n    }\n\n    function actionSheetHide(e) {\n      $('.action-sheet-modal').hide()\n      $('.action-sheet').removeClass('up')\n      e.stopPropagation()\n    }\n\n    $('.action-sheet').click((e) => {\n      e.stopPropagation()\n    })\n\n    $(document).click(() => {\n      $('.action-sheet-modal').hide()\n      $('.action-sheet').removeClass('up')\n    })\n  })\n})(Zepto)\n"],"file":"../js/index.js"}